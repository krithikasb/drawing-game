<!DOCTYPE html>
<html>
  <head>
    <link rel="stylesheet" type="text/css" href="./styles.css" />
    <!-- The core Firebase JS SDK is always required and must be listed first -->
    <script src="https://www.gstatic.com/firebasejs/8.9.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.9.1/firebase-database.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.9.1/firebase-auth.js"></script>
    <!-- TODO: Add SDKs for Firebase products that you want to use
        https://firebase.google.com/docs/web/setup#available-libraries -->
  </head>
  <body>
    <div id="homepage">
      <h1>Hello homepage!</h1>
      <input id="gameIdInput" placeholder="Enter game ID"/>
      <input id="userIdInput" placeholder="Enter user ID"/>
      <button id="create" onclick="onClickJoin()">Create/Join Game</button>
    </div>
    <div id="lobby" style="display: none;">
      <h1>Hello lobby!</h1>
      <ul id="userlist"></ul>
      <button disabled id="start" onclick="onClickStart()">Start Game</button>
    </div>
    <div id="game" style="display: none;">
      <h1 id="timer">&nbsp;</h1>
      <h1 id="word" class="word">&nbsp;</h1>
      <div class="canvasWrapper">
        <canvas id="canvas" width="800" height="600"></canvas>
        <div id="overlay" class="overlay hidden">
          <div id="overlayText">nextUser's turn</div>
        </div>
      </div>
      <div id="guessBox" class="guessBox">
        <p id="guessResponse">&nbsp;</p>
        <input type="text" id="guess" />
        <button type="submit" onclick="onClickGuess()">Guess</button>
      </div>
      <ul id="userlist2"></ul>
      <div class="toolbarWrapper">
        <button id="pencil" class="selected">Pencil</button>
        <button id="eraser">Eraser</button>
        <button id="stop" onclick="onClickStop()">Stop Game</button>
      </div>
    </div>
    <script src="firebase.js"></script>
    <script src="words.js"></script>
    <script src="canvas.controller.js"></script>
    <script src="game.controller.js"></script>
    <script>
      const urlSearchParams = new URLSearchParams(window.location.search);
      var gameId = urlSearchParams.get("game");
      var userName = "";
      var userMapping = {};
      var userList = [];
      // var uid = "";
      if(gameId) {
        // document.getElementById("homepage").style.display = "none";
        // document.getElementById("game").style.display = "block";
        document.getElementById("gameIdInput").value = gameId;
      } else {
        document.getElementById("game").style.display = "none";
        document.getElementById("homepage").style.display = "block";
        document.getElementById("gameIdInput").value = "game" + Math.floor(Math.random(1000) * 1000);
        document.getElementById("userIdInput").value = "user" + Math.floor(Math.random(1000) * 1000);
      }

      function onClickJoin() {
        const gameName = document.getElementById("gameIdInput").value || gameId;
        gameId = gameName;
        userName = document.getElementById("userIdInput").value || "user1"
        history.pushState({game: gameName}, "title 1", `?game=${gameName}`);
        console.log(history.state);
        document.getElementById("homepage").style.display = "none";
        document.getElementById("lobby").style.display = "block";
        document.getElementById("game").style.display = "none";
        signInToFirebase();    
        var userListFromFb = {};
        function onUserListChange(data) {
          userListFromFb = data;
          console.log("userlistlistener", data);
          userList = [];
          for(let key in userListFromFb) {
            let user = userListFromFb[key];
            userList.push(user);
            if(!userMapping[user.displayName]) {
              const userListElement = document.getElementById("userlist");
              const newListItem = document.createElement("li");
              newListItem.appendChild(document.createTextNode(user.displayName));
              userListElement.appendChild(newListItem);
              userMapping[user.displayName] = user.uid;
            }
            if(Object.keys(userListFromFb).length === 1 && user.displayName === displayName) {
              isAdmin = true;
              document.getElementById("start").disabled = false;
              setAdminInFirebase({
                uid: uid,
                displayName: displayName
              });
              setCurrentlyDrawingUserInFirebase({
                uid: uid,
                displayName: displayName
              });
              setGameStateInFirebase("lobby");
            }
          }
          if(!isAdmin) {
            function onGameStateChange(data) {
              if(data === "started") {
                startGame();
              }
            }
            listenToFirebaseValueChange(GAME_STATE, onGameStateChange);
          }
        }
        listenToFirebaseValueChange(USERS, onUserListChange);
      }

      function onClickStart() {
        startGame();
        if(isAdmin) {
          setGameStateInFirebase("started");
        }
      }

      function startGame() {
        document.getElementById("homepage").style.display = "none";
        document.getElementById("lobby").style.display = "none";
        document.getElementById("game").style.display = "block";
        document.getElementById("userlist2").innerHTML = "";
        for(let i = 0; i < userList.length; i++) {
          let user = userList[i];
          const userListElement = document.getElementById("userlist2");
          const newListItem = document.createElement("li");
          newListItem.id = user.displayName;
          if(i === userList.length - 1) {
            newListItem.classList.add("highlighted")
          }
          newListItem.appendChild(document.createTextNode(user.displayName));
          userListElement.appendChild(newListItem);
        }
        listenToFirebaseChanges();
      }

      function onClickStop() {
        history.back();
        console.log(history.state);
        document.getElementById("game").style.display = "none";
        document.getElementById("lobby").style.display = "none";
        document.getElementById("homepage").style.display = "block";
      }

      function onClickGuess(e) {
        let guessValue = document.getElementById("guess").value;
        if(guessValue.trim().toLowerCase() === correctWord.toLowerCase()) {
          document.getElementById("guessResponse").innerText = "You guessed it!";
          document.getElementById("guess").disabled = true;

          //push guessed user
          pushGuessedUserInFirebase({
            uid: uid,
            displayName: displayName
          });

          // update current user score
          updateCurrentUserScoreInFirebase(score + 10);
        } else {
          document.getElementById("guessResponse").innerText = "Try again"
          guessValue = "";
        }
      }
    </script>
  </body>
</html>
